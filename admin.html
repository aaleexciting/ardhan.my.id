<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Ardan Ridho</title>
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            transition: background-color 0.3s ease, color 0.3s ease; 
        }

        .light {
            --bg-primary: #f3f4f6; --bg-secondary: #ffffff; --bg-sidebar: #1f2937; --text-primary: #1f2937; --text-secondary: #6b7280; --text-on-sidebar: #f3f4f6; --border-color: #e5e7eb; --shadow-color: rgba(0, 0, 0, 0.07); --btn-primary-bg: #3b82f6; --btn-primary-text: #ffffff; --btn-danger-bg: #ef4444; --btn-danger-text: #ffffff; --btn-secondary-bg: #e5e7eb; --btn-secondary-text: #374151; --glow-color: rgba(59, 130, 246, 0.2);
        }
        .dark {
            --bg-primary: #111827; --bg-secondary: #1f2937; --bg-sidebar: #111827; --text-primary: #f3f4f6; --text-secondary: #9ca3af; --text-on-sidebar: #d1d5db; --border-color: #374151; --shadow-color: rgba(0, 0, 0, 0.25); --btn-primary-bg: #2563eb; --btn-primary-text: #ffffff; --btn-danger-bg: #dc2626; --btn-danger-text: #ffffff; --btn-secondary-bg: #374151; --btn-secondary-text: #d1d5db; --glow-color: rgba(37, 99, 235, 0.3);
        }
        
        .bg-primary { background-color: var(--bg-primary); } .bg-secondary { background-color: var(--bg-secondary); } .bg-sidebar { background-color: var(--bg-sidebar); } .text-primary { color: var(--text-primary); } .text-secondary { color: var(--text-secondary); } .text-on-sidebar { color: var(--text-on-sidebar); } .border-color { border-color: var(--border-color); } .btn-primary-bg { background-color: var(--btn-primary-bg); } .btn-primary-text { color: var(--btn-primary-text); } .btn-danger-bg { background-color: var(--btn-danger-bg); } .btn-danger-text { color: var(--btn-danger-text); } .btn-secondary-bg { background-color: var(--btn-secondary-bg); } .btn-secondary-text { color: var(--btn-secondary-text); } .shadow-custom { box-shadow: 0 4px 6px -1px var(--shadow-color), 0 2px 4px -1px var(--shadow-color); } .input-style { background-color: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 0.5rem; padding: 0.75rem; width: 100%; transition: border-color 0.2s, box-shadow 0.2s; } .input-style:focus { outline: none; border-color: var(--btn-primary-bg); box-shadow: 0 0 0 3px var(--glow-color); }
        
        #form-modal { transition: opacity 0.3s ease-in-out; }
        .modal-content { transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; }
        .dark .ql-toolbar { border-color: var(--border-color) !important; border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem;}
        .dark .ql-container { border-color: var(--border-color) !important; border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem;}
        .dark .ql-editor { background-color: var(--bg-primary); color: var(--text-primary); }
        .dark .ql-snow .ql-stroke { stroke: var(--text-secondary); }
        .dark .ql-snow .ql-picker-label { color: var(--text-secondary); }
        .dark .ql-snow .ql-picker { color: var(--text-secondary); }
        .light .ql-toolbar { border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem; }
        .light .ql-container { border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; }
        .sidebar-link.active { background-color: var(--btn-primary-bg); color: var(--btn-primary-text); }
    </style>
</head>
<body class="bg-primary">

    <div id="login-section" class="flex items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-md p-8 space-y-6 bg-secondary rounded-2xl shadow-custom">
            <div class="text-center">
                <i class="fas fa-lock text-3xl text-primary"></i>
                <h1 class="text-3xl font-bold text-center text-primary mt-4">Admin Panel Access</h1>
                <p class="text-secondary mt-2">Please sign in to manage your portfolio.</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="email" class="text-sm font-medium text-secondary">Email address</label>
                    <input type="email" id="email" required class="input-style mt-2">
                </div>
                <div>
                    <label for="password" class="text-sm font-medium text-secondary">Password</label>
                    <input type="password" id="password" required class="input-style mt-2">
                </div>
                <button type="submit" class="w-full px-4 py-3 font-semibold text-center rounded-lg btn-primary-bg btn-primary-text transition hover:opacity-90 active:scale-95">Sign In</button>
                <p id="login-error" class="text-sm text-center text-red-500 h-4"></p>
            </form>
        </div>
    </div>

    <div id="admin-panel" class="hidden">
        <!-- Sidebar -->
        <div id="sidebar" class="fixed inset-y-0 left-0 bg-sidebar text-on-sidebar w-64 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out z-40 flex flex-col">
             <div class="flex items-center justify-center h-20 border-b border-gray-700 flex-shrink-0">
                <h1 class="text-2xl font-bold">Admin</h1>
            </div>
            <nav class="flex-1 px-4 py-6 space-y-2 overflow-y-auto">
                <a href="#" id="projects-link" class="sidebar-link flex items-center px-4 py-2.5 rounded-lg transition-colors duration-200"><i class="fas fa-tasks w-6 mr-3"></i><span>Projects</span></a>
                <a href="#" id="portfolio-link" class="sidebar-link flex items-center px-4 py-2.5 rounded-lg transition-colors duration-200"><i class="fas fa-briefcase w-6 mr-3"></i><span>Portfolio</span></a>
                <a href="#" id="shortlinks-link" class="sidebar-link flex items-center px-4 py-2.5 rounded-lg transition-colors duration-200"><i class="fas fa-link w-6 mr-3"></i><span>Shortlinks</span></a>
            </nav>
            <div class="p-4 border-t border-gray-700 space-y-3 flex-shrink-0">
                 <button id="theme-toggle" class="w-full flex items-center justify-start py-2.5 px-4 text-gray-300 rounded-lg hover:bg-gray-700 transition-colors"><i class="fas fa-sun w-6 mr-3"></i><span>Toggle Theme</span></button>
                <a href="#" id="logout-button" class="w-full flex items-center justify-start py-2.5 px-4 text-gray-300 rounded-lg hover:bg-red-500/50 hover:text-white transition-colors"><i class="fas fa-sign-out-alt w-6 mr-3"></i><span>Logout</span></a>
            </div>
        </div>
        <div id="sidebar-overlay" class="fixed inset-0 bg-black opacity-50 hidden z-30 lg:hidden"></div>

        <div class="lg:ml-64 transition-all duration-300 ease-in-out">
            <header class="lg:hidden bg-secondary shadow-md sticky top-0 z-20">
                <div class="flex items-center justify-between p-4">
                    <button id="sidebar-toggle" class="text-primary text-xl">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 id="mobile-header-title" class="text-xl font-bold text-primary">Dashboard</h1>
                     <div class="w-8"></div>
                </div>
            </header>

            <main class="p-4 sm:p-6 lg:p-10">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4 mb-8">
                    <h1 id="main-content-title" class="text-3xl font-bold text-primary hidden lg:block"></h1>
                    <button id="add-new-btn" class="w-full sm:w-auto px-5 py-2.5 font-semibold rounded-lg btn-primary-bg btn-primary-text flex items-center justify-center space-x-2 transition hover:opacity-90 active:scale-95"><i class="fas fa-plus"></i><span>Add New Item</span></button>
                </div>
                <div id="content-area" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                </div>
            </main>
        </div>
    </div>
    
    <div id="form-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center p-4">
        <div class="bg-secondary rounded-2xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col modal-content transform scale-95 opacity-0">
            <div class="flex justify-between items-center p-5 border-b border-color flex-shrink-0">
                <h2 id="modal-title" class="text-2xl font-bold text-primary"></h2>
                <button id="close-modal-btn" class="p-2 rounded-full hover:bg-primary text-secondary hover:text-primary transition-colors"><i class="fas fa-times"></i></button>
            </div>
            <div class="overflow-y-auto">
                <form id="item-form" class="p-6 space-y-5">
                    <input type="hidden" id="item-id">
                    <input type="hidden" id="item-type-collection">
                    <div>
                        <label for="item-title" class="block text-sm font-medium text-secondary mb-2">Title</label>
                        <input type="text" id="item-title" class="input-style" required>
                    </div>
                    <div>
                        <label for="item-image" class="block text-sm font-medium text-secondary mb-2">Thumbnail Image URL (for Banner)</label>
                        <input type="url" id="item-image" class="input-style" placeholder="https://example.com/image.png" required>
                    </div>
                    <div>
                        <label for="item-external-url" class="block text-sm font-medium text-secondary mb-2">Live Project URL (Optional)</label>
                        <input type="url" id="item-external-url" class="input-style" placeholder="https://www.youtube.com/watch?v=...">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-2">Page Content</label>
                        <div id="editor-container" class="bg-secondary rounded-lg">
                            <div id="quill-editor" style="min-height: 250px;"></div>
                        </div>
                    </div>
                </form>
                <form id="shortlink-form" class="p-6 space-y-5 hidden">
                    <input type="hidden" id="shortlink-id">
                     <div>
                        <label for="shortlink-slug" class="block text-sm font-medium text-secondary mb-2">Short Link (e.g., 'cv' for ardhan.my.id/cv)</label>
                        <input type="text" id="shortlink-slug" class="input-style" placeholder="cv" required>
                    </div>
                    <div>
                        <label for="shortlink-url" class="block text-sm font-medium text-secondary mb-2">Original URL (The link to redirect to)</label>
                        <input type="url" id="shortlink-url" class="input-style" placeholder="https://your-long-url.com/goes/here" required>
                    </div>
                </form>
            </div>
            <div class="flex justify-end p-5 border-t border-color bg-primary rounded-b-2xl flex-shrink-0">
                 <button type="button" id="cancel-btn" class="px-6 py-2.5 font-semibold rounded-lg btn-secondary-bg btn-secondary-text mr-3 transition hover:opacity-90">Cancel</button>
                <button id="save-item-btn" class="px-6 py-2.5 font-semibold rounded-lg btn-primary-bg btn-primary-text transition hover:opacity-90 active:scale-95">Save</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, deleteDoc, serverTimestamp, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

        async function initializeAdminPanel() {
            try {
                const response = await fetch('/.netlify/functions/firebase-config');
                if (!response.ok) throw new Error(`Firebase config fetch failed: ${response.statusText}`);
                const firebaseConfig = await response.json();

                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);

                let currentCollection = 'projects';
                let unsubscribe;

                const quill = new Quill('#quill-editor', {
                    theme: 'snow',
                    modules: { toolbar: [ [{'header': [1,2,3,false]}], ['bold','italic','underline','strike'], ['blockquote','code-block'], [{'list':'ordered'},{'list':'bullet'}], ['link','image','video'], ['clean'] ] }
                });

                onAuthStateChanged(auth, user => {
                    document.getElementById('login-section').classList.toggle('hidden', !!user);
                    document.getElementById('admin-panel').classList.toggle('hidden', !user);
                    if (user) setupDashboard();
                    else if (unsubscribe) unsubscribe();
                });

                document.getElementById('login-form').addEventListener('submit', e => {
                    e.preventDefault();
                    signInWithEmailAndPassword(auth, e.target.email.value, e.target.password.value)
                        .catch(err => document.getElementById('login-error').textContent = err.message);
                });

                document.getElementById('logout-button').addEventListener('click', () => signOut(auth));
                
                function setupDashboard() {
                    setupNavListeners();
                    setupMobileNav();
                    switchView('projects');
                    setupModalListeners();
                }

                function switchView(collectionName) {
                    currentCollection = collectionName;
                    const title = `${collectionName.charAt(0).toUpperCase() + collectionName.slice(1)} Management`;
                    document.getElementById('main-content-title').textContent = title;
                    document.getElementById('mobile-header-title').textContent = collectionName.charAt(0).toUpperCase() + collectionName.slice(1);

                    document.querySelectorAll('.sidebar-link').forEach(link => link.classList.remove('active'));
                    document.getElementById(`${collectionName}-link`).classList.add('active');
                    
                    if (unsubscribe) unsubscribe();
                    
                    const contentArea = document.getElementById('content-area');
                    contentArea.innerHTML = `<div class="text-center py-12 text-secondary col-span-full"><i class="fas fa-spinner fa-spin fa-2x"></i></div>`;
                    
                    unsubscribe = onSnapshot(collection(db, currentCollection), snapshot => {
                        const items = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                        if (collectionName === 'shortlinks') {
                            renderShortlinks(items);
                        } else {
                            renderContent(items);
                        }
                    });
                }

                function renderContent(items) {
                    const container = document.getElementById('content-area');
                    if (items.length === 0) {
                        container.innerHTML = `<div class="col-span-full text-center py-20 bg-secondary rounded-lg border-2 border-dashed border-color"><i class="fas fa-folder-open fa-3x text-secondary"></i><p class="mt-4 text-lg font-medium text-primary">No ${currentCollection} items yet.</p><p class="text-secondary">Click "Add New Item" to get started.</p></div>`;
                        return;
                    }
                    container.innerHTML = items.sort((a,b) => b.createdAt?.toMillis() - a.createdAt?.toMillis()).map(item => `
                        <div class="bg-secondary rounded-lg shadow-custom flex flex-col">
                            <div class="p-5 flex-grow">
                                <h3 class="font-bold text-primary text-lg mb-2">${item.title}</h3>
                                <p class="text-sm text-secondary mb-3">Created: ${item.createdAt ? new Date(item.createdAt.toDate()).toLocaleString() : 'N/A'}</p>
                                <span class="text-xs font-semibold inline-flex items-center px-2.5 py-0.5 rounded-full ${item.externalUrl ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'} dark:bg-green-900 dark:text-green-300 dark:bg-gray-700 dark:text-gray-300">
                                    <i class="fas ${item.externalUrl ? 'fa-check-circle mr-1.5' : 'fa-minus-circle mr-1.5'}"></i>
                                    ${item.externalUrl ? 'Has Live Link' : 'No Live Link'}
                                </span>
                            </div>
                            <div class="border-t border-color p-3 flex justify-end items-center space-x-2">
                                <button class="edit-btn text-blue-500 hover:text-blue-700 p-2 rounded-md hover:bg-primary transition-colors" data-id="${item.id}" aria-label="Edit"><i class="fas fa-pencil-alt"></i></button>
                                <button class="delete-btn text-red-500 hover:text-red-700 p-2 rounded-md hover:bg-primary transition-colors" data-id="${item.id}" aria-label="Delete"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>`).join('');
                    container.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', handleEdit));
                    container.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', handleDelete));
                }

                function renderShortlinks(items) {
                    const container = document.getElementById('content-area');
                     if (items.length === 0) {
                        container.innerHTML = `<div class="col-span-full text-center py-20 bg-secondary rounded-lg border-2 border-dashed border-color"><i class="fas fa-folder-open fa-3x text-secondary"></i><p class="mt-4 text-lg font-medium text-primary">No shortlinks yet.</p><p class="text-secondary">Click "Add New Item" to create one.</p></div>`;
                        return;
                    }
                    container.innerHTML = items.map(item => `
                        <div class="bg-secondary rounded-lg shadow-custom p-5">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-sm font-semibold text-blue-500 font-mono">ardhan.my.id/${item.id}</p>
                                    <p class="text-secondary text-sm break-all mt-1">${item.url}</p>
                                </div>
                                <button class="delete-btn text-red-500 hover:text-red-700 p-2 rounded-md hover:bg-primary transition-colors flex-shrink-0 ml-2" data-id="${item.id}" aria-label="Delete"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>`).join('');
                    container.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', handleDelete));
                }

                function setupNavListeners() {
                    document.getElementById('projects-link').addEventListener('click', (e) => { e.preventDefault(); switchView('projects'); });
                    document.getElementById('portfolio-link').addEventListener('click', (e) => { e.preventDefault(); switchView('portfolio'); });
                    document.getElementById('shortlinks-link').addEventListener('click', (e) => { e.preventDefault(); switchView('shortlinks'); });
                }
                
                const modal = document.getElementById('form-modal');
                const modalContent = modal.querySelector('.modal-content');
                const itemForm = document.getElementById('item-form');
                const shortlinkForm = document.getElementById('shortlink-form');
                
                function openModal() { modal.classList.remove('hidden'); modal.classList.add('flex'); setTimeout(() => modalContent.classList.remove('scale-95', 'opacity-0'), 50); }
                function closeModal() { modalContent.classList.add('scale-95', 'opacity-0'); setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); itemForm.reset(); shortlinkForm.reset(); itemForm.classList.add('hidden'); shortlinkForm.classList.add('hidden'); }, 300); }
                
                function setupModalListeners() {
                    document.getElementById('add-new-btn').addEventListener('click', () => {
                        document.getElementById('item-id').value = '';
                        document.getElementById('item-type-collection').value = currentCollection;
                        if (currentCollection === 'shortlinks') {
                            shortlinkForm.reset();
                            document.getElementById('shortlink-id').value = '';
                            document.getElementById('modal-title').textContent = `Add New Shortlink`;
                            shortlinkForm.classList.remove('hidden');
                            itemForm.classList.add('hidden');
                        } else {
                            itemForm.reset();
                            quill.root.innerHTML = '';
                            document.getElementById('modal-title').textContent = `Add New ${currentCollection.slice(0,-1)}`;
                            itemForm.classList.remove('hidden');
                            shortlinkForm.classList.add('hidden');
                        }
                        openModal();
                    });
                    
                    document.getElementById('close-modal-btn').addEventListener('click', closeModal);
                    document.getElementById('cancel-btn').addEventListener('click', closeModal);
                    document.getElementById('save-item-btn').addEventListener('click', handleSave);
                }

                function setupMobileNav() {
                    const sidebar = document.getElementById('sidebar');
                    const sidebarToggle = document.getElementById('sidebar-toggle');
                    const sidebarOverlay = document.getElementById('sidebar-overlay');

                    function openSidebar() {
                        sidebar.classList.remove('-translate-x-full');
                        sidebarOverlay.classList.remove('hidden');
                    }

                    function closeSidebar() {
                        sidebar.classList.add('-translate-x-full');
                        sidebarOverlay.classList.add('hidden');
                    }

                    sidebarToggle.addEventListener('click', openSidebar);
                    sidebarOverlay.addEventListener('click', closeSidebar);
                    document.querySelectorAll('.sidebar-link').forEach(link => {
                        link.addEventListener('click', () => {
                             if(window.innerWidth < 1024) closeSidebar();
                        });
                    });
                }
                
                async function handleEdit(e) {
                    const id = e.currentTarget.dataset.id;
                    const docRef = doc(db, currentCollection, id);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const item = docSnap.data();
                        itemForm.classList.remove('hidden');
                        shortlinkForm.classList.add('hidden');
                        document.getElementById('item-id').value = id;
                        document.getElementById('item-type-collection').value = currentCollection;
                        document.getElementById('item-title').value = item.title;
                        document.getElementById('item-image').value = item.imageUrl;
                        document.getElementById('item-external-url').value = item.externalUrl || '';
                        quill.root.innerHTML = item.content || '';
                        document.getElementById('modal-title').textContent = `Editing: ${item.title}`;
                        openModal();
                    }
                }

                async function handleDelete(e) {
                    const id = e.currentTarget.dataset.id;
                    if (confirm(`Are you sure you want to delete this item? This cannot be undone.`)) {
                        await deleteDoc(doc(db, currentCollection, id));
                    }
                }

                async function handleSave() {
                    if (currentCollection === 'shortlinks') {
                        const slug = document.getElementById('shortlink-slug').value.trim();
                        const url = document.getElementById('shortlink-url').value.trim();
                        if (!slug || !url) { alert('Please provide both a short link and an original URL.'); return; }
                        await setDoc(doc(db, "shortlinks", slug), { url: url });
                    } else {
                         const id = document.getElementById('item-id').value;
                        const collectionName = document.getElementById('item-type-collection').value;
                        const data = {
                            title: document.getElementById('item-title').value,
                            imageUrl: document.getElementById('item-image').value,
                            externalUrl: document.getElementById('item-external-url').value,
                            content: quill.root.innerHTML,
                        };
                        if (id) {
                            data.updatedAt = serverTimestamp();
                            await updateDoc(doc(db, collectionName, id), data);
                        } else {
                            data.createdAt = serverTimestamp();
                            await addDoc(collection(db, collectionName), data);
                        }
                    }
                    closeModal();
                }

                const themeToggle = document.getElementById('theme-toggle');
                const htmlElement = document.documentElement;
                function applyTheme(theme) {
                    htmlElement.classList.toggle('dark', theme === 'dark');
                    htmlElement.classList.toggle('light', theme !== 'dark');
                }
                const savedTheme = localStorage.getItem('theme') || 'light';
                applyTheme(savedTheme);
                themeToggle.addEventListener('click', () => {
                    const newTheme = htmlElement.classList.contains('dark') ? 'light' : 'dark';
                    applyTheme(newTheme);
                    localStorage.setItem('theme', newTheme);
                });

            } catch (error) {
                console.error("Failed to initialize admin panel:", error);
                document.body.innerHTML = `<div class="flex items-center justify-center min-h-screen p-4 bg-primary text-primary text-center"><div><i class="fas fa-exclamation-triangle fa-3x text-red-500"></i><h1 class="text-2xl font-bold mt-4">Initialization Failed</h1><p class="text-secondary mt-2">Could not load the admin panel. Please check the browser console for more details and ensure the serverless function is deployed correctly.</p></div></div>`;
            }
        }

        document.addEventListener('DOMContentLoaded', initializeAdminPanel);
    </script>
</body>
</html>
