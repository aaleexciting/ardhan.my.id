<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Ardan Ridho</title>
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <style>
        /* Base styles and variables */
        body { 
            font-family: 'Inter', sans-serif; 
            transition: background-color 0.3s ease, color 0.3s ease; 
        }

        /* --- Theme variables --- */
        .light {
            --bg-primary: #f3f4f6;
            --bg-secondary: #ffffff;
            --bg-sidebar: #1f2937;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-on-sidebar: #f3f4f6;
            --border-color: #e5e7eb;
            --shadow-color: rgba(0, 0, 0, 0.07);
            --btn-primary-bg: #3b82f6;
            --btn-primary-text: #ffffff;
            --btn-danger-bg: #ef4444;
            --btn-danger-text: #ffffff;
            --btn-secondary-bg: #e5e7eb;
            --btn-secondary-text: #374151;
            --glow-color: rgba(59, 130, 246, 0.2);
        }
        .dark {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-sidebar: #111827;
            --text-primary: #f3f4f6;
            --text-secondary: #9ca3af;
            --text-on-sidebar: #d1d5db;
            --border-color: #374151;
            --shadow-color: rgba(0, 0, 0, 0.25);
            --btn-primary-bg: #2563eb;
            --btn-primary-text: #ffffff;
            --btn-danger-bg: #dc2626;
            --btn-danger-text: #ffffff;
            --btn-secondary-bg: #374151;
            --btn-secondary-text: #d1d5db;
            --glow-color: rgba(37, 99, 235, 0.3);
        }
        
        /* --- Applying theme variables --- */
        .bg-primary { background-color: var(--bg-primary); }
        .bg-secondary { background-color: var(--bg-secondary); }
        .bg-sidebar { background-color: var(--bg-sidebar); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .text-on-sidebar { color: var(--text-on-sidebar); }
        .border-color { border-color: var(--border-color); }
        .btn-primary-bg { background-color: var(--btn-primary-bg); }
        .btn-primary-text { color: var(--btn-primary-text); }
        .btn-danger-bg { background-color: var(--btn-danger-bg); }
        .btn-danger-text { color: var(--btn-danger-text); }
        .btn-secondary-bg { background-color: var(--btn-secondary-bg); }
        .btn-secondary-text { color: var(--btn-secondary-text); }
        .shadow-custom { box-shadow: 0 4px 6px -1px var(--shadow-color), 0 2px 4px -1px var(--shadow-color); }
        .input-style { 
            background-color: var(--bg-primary); 
            border: 1px solid var(--border-color); 
            color: var(--text-primary); 
            border-radius: 0.5rem; 
            padding: 0.75rem; 
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-style:focus {
            outline: none;
            border-color: var(--btn-primary-bg);
            box-shadow: 0 0 0 3px var(--glow-color);
        }
        
        /* --- Component Styles --- */
        .modal { transition: opacity 0.3s ease-in-out; }
        .modal-content { transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; }
        .dark .ql-toolbar { border-color: var(--border-color) !important; border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem;}
        .dark .ql-container { border-color: var(--border-color) !important; border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem;}
        .dark .ql-editor { background-color: var(--bg-primary); color: var(--text-primary); }
        .dark .ql-snow .ql-stroke { stroke: var(--text-secondary); }
        .dark .ql-snow .ql-picker-label { color: var(--text-secondary); }
        .dark .ql-snow .ql-picker { color: var(--text-secondary); }

        .light .ql-toolbar { border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem; }
        .light .ql-container { border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; }

        .sidebar-link.active {
            background-color: var(--btn-primary-bg);
            color: var(--btn-primary-text);
        }
    </style>
</head>
<body class="bg-primary">

    <!-- Login Section -->
    <div id="login-section" class="flex items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-md p-8 space-y-6 bg-secondary rounded-2xl shadow-custom">
            <div class="text-center">
                <i class="fas fa-lock text-3xl text-primary"></i>
                <h1 class="text-3xl font-bold text-center text-primary mt-4">Admin Panel Access</h1>
                <p class="text-secondary mt-2">Please sign in to manage your portfolio.</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="email" class="text-sm font-medium text-secondary">Email address</label>
                    <input type="email" id="email" required class="input-style mt-2">
                </div>
                <div>
                    <label for="password" class="text-sm font-medium text-secondary">Password</label>
                    <input type="password" id="password" required class="input-style mt-2">
                </div>
                <button type="submit" class="w-full px-4 py-3 font-semibold text-center rounded-lg btn-primary-bg btn-primary-text transition hover:opacity-90 active:scale-95">Sign In</button>
                <p id="login-error" class="text-sm text-center text-red-500 h-4"></p>
            </form>
        </div>
    </div>

    <!-- Main Admin Dashboard -->
    <div id="admin-panel" class="hidden">
        <div class="flex h-screen bg-primary">
            <!-- Sidebar -->
            <div class="flex-shrink-0 w-64 bg-sidebar text-on-sidebar flex flex-col">
                <div class="flex items-center justify-center h-20 border-b border-gray-700">
                    <h1 class="text-2xl font-bold">Admin</h1>
                </div>
                <nav class="flex-1 px-4 py-6 space-y-2">
                    <a href="#" id="projects-link" class="sidebar-link flex items-center px-4 py-2.5 rounded-lg transition-colors duration-200"><i class="fas fa-tasks w-6"></i><span>Projects</span></a>
                    <a href="#" id="portfolio-link" class="sidebar-link flex items-center px-4 py-2.5 rounded-lg transition-colors duration-200"><i class="fas fa-briefcase w-6"></i><span>Portfolio</span></a>
                    <a href="#" id="shortlinks-link" class="sidebar-link flex items-center px-4 py-2.5 rounded-lg transition-colors duration-200"><i class="fas fa-link w-6"></i><span>Shortlinks</span></a>
                </nav>
                <div class="p-4 border-t border-gray-700 space-y-3">
                     <button id="theme-toggle" class="w-full flex items-center justify-start py-2 px-4 text-gray-300 rounded-lg hover:bg-gray-700 transition-colors"><i class="fas fa-sun w-6"></i><span>Toggle Theme</span></button>
                    <a href="#" id="logout-button" class="w-full flex items-center justify-start py-2 px-4 text-gray-300 rounded-lg hover:bg-red-500/50 hover:text-white transition-colors"><i class="fas fa-sign-out-alt w-6"></i><span>Logout</span></a>
                </div>
            </div>

            <!-- Main Content -->
            <main class="flex-1 p-6 sm:p-10 overflow-y-auto">
                <div class="flex justify-between items-center">
                    <h1 id="main-content-title" class="text-3xl font-bold text-primary"></h1>
                    <button id="add-new-btn" class="px-5 py-2 font-semibold rounded-lg btn-primary-bg btn-primary-text flex items-center space-x-2 transition hover:opacity-90 active:scale-95"><i class="fas fa-plus"></i><span>Add New Item</span></button>
                </div>
                <div id="content-area" class="mt-8"></div>
            </main>
        </div>
    </div>
    
    <!-- Add/Edit Modal (shared for all types) -->
    <div id="form-modal" class="modal fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center p-4">
        <div class="bg-secondary rounded-2xl shadow-xl w-full max-w-4xl max-h-full overflow-hidden flex flex-col modal-content transform scale-95 opacity-0">
            <div class="flex justify-between items-center p-5 border-b border-color">
                <h2 id="modal-title" class="text-2xl font-bold text-primary"></h2>
                <button id="close-modal-btn" class="p-2 rounded-full hover:bg-primary text-secondary hover:text-primary transition-colors"><i class="fas fa-times"></i></button>
            </div>
            <!-- Form for Projects/Portfolio -->
            <form id="item-form" class="p-6 space-y-5 overflow-y-auto hidden">
                <input type="hidden" id="item-id">
                <div>
                    <label for="item-title" class="block text-sm font-medium text-secondary mb-2">Title</label>
                    <input type="text" id="item-title" class="input-style" required>
                </div>
                <div>
                    <label for="item-image" class="block text-sm font-medium text-secondary mb-2">Thumbnail Image URL (for Banner)</label>
                    <input type="url" id="item-image" class="input-style" placeholder="https://example.com/image.png" required>
                </div>
                <div>
                    <label for="item-external-url" class="block text-sm font-medium text-secondary mb-2">Live Project URL (Optional)</label>
                    <input type="url" id="item-external-url" class="input-style" placeholder="https://www.youtube.com/watch?v=...">
                </div>
                <div>
                    <label class="block text-sm font-medium text-secondary mb-2">Page Content</label>
                    <div id="editor-container" class="bg-secondary rounded-lg">
                        <div id="quill-editor" style="min-height: 250px;"></div>
                    </div>
                </div>
            </form>
            <!-- Form for Shortlinks -->
            <form id="shortlink-form" class="p-6 space-y-5 overflow-y-auto hidden">
                 <div>
                    <label for="shortlink-slug" class="block text-sm font-medium text-secondary mb-2">Custom Short Link (e.g., 'cv' for ardhan.my.id/cv)</label>
                    <div class="flex items-center space-x-2">
                         <input type="text" id="shortlink-slug" class="input-style" placeholder="my-awesome-link" required>
                         <button type="button" id="generate-slug-btn" class="px-4 py-2.5 font-semibold rounded-lg btn-secondary-bg btn-secondary-text transition hover:opacity-90">Generate</button>
                    </div>
                </div>
                <div>
                    <label for="shortlink-url" class="block text-sm font-medium text-secondary mb-2">Original URL (The link to redirect to)</label>
                    <input type="url" id="shortlink-url" class="input-style" placeholder="https://your-long-url.com/goes/here" required>
                </div>
            </form>
            <div class="flex justify-end p-5 border-t border-color bg-primary rounded-b-2xl">
                 <button type="button" id="cancel-btn" class="px-6 py-2.5 font-semibold rounded-lg btn-secondary-bg btn-secondary-text mr-3 transition hover:opacity-90">Cancel</button>
                <button id="save-item-btn" class="px-6 py-2.5 font-semibold rounded-lg btn-primary-bg btn-primary-text transition hover:opacity-90 active:scale-95">Save</button>
            </div>
        </div>
    </div>

    <!-- Clicks Detail Modal -->
    <div id="clicks-modal" class="modal fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center p-4">
        <div class="bg-secondary rounded-2xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col modal-content transform scale-95 opacity-0">
            <div class="flex justify-between items-center p-5 border-b border-color">
                <h2 id="clicks-modal-title" class="text-2xl font-bold text-primary">Click Details</h2>
                <button id="close-clicks-modal-btn" class="p-2 rounded-full hover:bg-primary text-secondary hover:text-primary transition-colors"><i class="fas fa-times"></i></button>
            </div>
            <div id="clicks-modal-body" class="p-6 overflow-y-auto">
                <!-- Click data will be rendered here -->
            </div>
        </div>
    </div>


    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, deleteDoc, serverTimestamp, getDoc, setDoc, query, getDocs } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

        // --- Firebase Initialization ---
        const firebaseConfig = {
            apiKey: "AIzaSyCCzxxZ0pujMyzvvRorepkzaBWwO1RhUsg",
            authDomain: "ardhan-s-website.firebaseapp.com",
            projectId: "ardhan-s-website",
            storageBucket: "ardhan-s-website.appspot.com",
            messagingSenderId: "1064954728511",
            appId: "1:1064954728511:web:b1f2e5ed21bbe0bc14a88a",
            measurementId: "G-P7P7WEXTNV"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentCollection = 'projects';
        let unsubscribe;

        const quill = new Quill('#quill-editor', {
            theme: 'snow',
            modules: { toolbar: [ [{'header': [1,2,3,false]}], ['bold','italic','underline','strike'], ['blockquote','code-block'], [{'list':'ordered'},{'list':'bullet'}], ['link','image','video'], ['clean'] ] }
        });

        // --- Auth ---
        onAuthStateChanged(auth, user => {
            document.getElementById('login-section').classList.toggle('hidden', !!user);
            document.getElementById('admin-panel').classList.toggle('hidden', !user);
            if (user) setupDashboard();
            else if (unsubscribe) unsubscribe();
        });

        document.getElementById('login-form').addEventListener('submit', e => {
            e.preventDefault();
            signInWithEmailAndPassword(auth, e.target.email.value, e.target.password.value)
                .catch(err => document.getElementById('login-error').textContent = err.message);
        });

        document.getElementById('logout-button').addEventListener('click', () => signOut(auth));
        
        // --- Dashboard ---
        function setupDashboard() {
            setupNavListeners();
            switchView('projects');
            setupModalListeners();
        }

        function switchView(collectionName) {
            currentCollection = collectionName;
            document.getElementById('main-content-title').textContent = `${collectionName.charAt(0).toUpperCase() + collectionName.slice(1)} Management`;
            document.querySelectorAll('.sidebar-link').forEach(link => link.classList.remove('active'));
            document.getElementById(`${collectionName}-link`).classList.add('active');
            
            if (unsubscribe) unsubscribe();
            
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `<div class="text-center py-12 text-secondary"><i class="fas fa-spinner fa-spin fa-2x"></i></div>`;
            
            unsubscribe = onSnapshot(collection(db, currentCollection), snapshot => {
                const items = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                if (collectionName === 'shortlinks') {
                    renderShortlinks(items);
                } else {
                    renderContent(items);
                }
            });
        }

        function renderContent(items) {
            const container = document.getElementById('content-area');
            if (items.length === 0) {
                container.innerHTML = `<div class="text-center py-20 bg-secondary rounded-lg border-2 border-dashed border-color">
                    <i class="fas fa-folder-open fa-3x text-secondary"></i>
                    <p class="mt-4 text-lg font-medium text-primary">No ${currentCollection} items yet.</p>
                    <p class="text-secondary">Click "Add New Item" to get started.</p>
                </div>`;
                return;
            }
            container.innerHTML = `
                <div class="bg-secondary rounded-lg shadow-custom overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="border-b border-color">
                            <tr>
                                <th class="p-4 font-semibold text-primary">Title</th>
                                <th class="p-4 font-semibold text-primary">Has Live Link?</th>
                                <th class="p-4 font-semibold text-primary">Created At</th>
                                <th class="p-4 font-semibold text-primary text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items.sort((a,b) => b.createdAt?.toMillis() - a.createdAt?.toMillis()).map(item => `
                                <tr class="border-b border-color last:border-b-0">
                                    <td class="p-4 text-primary align-middle font-medium">${item.title}</td>
                                    <td class="p-4 text-secondary align-middle">
                                        ${item.externalUrl ? '<i class="fas fa-check-circle text-green-500"></i> Yes' : '<i class="fas fa-minus-circle text-gray-400"></i> No'}
                                    </td>
                                    <td class="p-4 text-secondary align-middle">${item.createdAt ? new Date(item.createdAt.toDate()).toLocaleString() : 'N/A'}</td>
                                    <td class="p-4 text-right align-middle">
                                        <button class="edit-btn text-blue-500 hover:text-blue-700 mr-3 p-2" data-id="${item.id}"><i class="fas fa-pencil-alt"></i></button>
                                        <button class="delete-btn text-red-500 hover:text-red-700 p-2" data-id="${item.id}"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>`;
            container.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', handleEdit));
            container.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', handleDelete));
        }

        function renderShortlinks(items) {
            const container = document.getElementById('content-area');
             if (items.length === 0) {
                container.innerHTML = `<div class="text-center py-20 bg-secondary rounded-lg border-2 border-dashed border-color">
                    <i class="fas fa-folder-open fa-3x text-secondary"></i>
                    <p class="mt-4 text-lg font-medium text-primary">No shortlinks yet.</p>
                    <p class="text-secondary">Click "Add New Item" to create one.</p>
                </div>`;
                return;
            }
            container.innerHTML = `
                <div class="bg-secondary rounded-lg shadow-custom overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="border-b border-color">
                            <tr>
                                <th class="p-4 font-semibold text-primary">Short Link</th>
                                <th class="p-4 font-semibold text-primary">Original URL</th>
                                <th class="p-4 font-semibold text-primary">Clicks</th>
                                <th class="p-4 font-semibold text-primary">Created</th>
                                <th class="p-4 font-semibold text-primary text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                             ${items.sort((a,b) => b.createdAt?.toMillis() - a.createdAt?.toMillis()).map(item => `
                                <tr class="border-b border-color last:border-b-0">
                                    <td class="p-4 text-blue-500 align-middle font-mono">
                                        <a href="https://ardhan.my.id/${item.id}" target="_blank" rel="noopener noreferrer">ardhan.my.id/${item.id}</a>
                                    </td>
                                    <td class="p-4 text-secondary align-middle truncate max-w-sm" title="${item.url}">${item.url}</td>
                                    <td class="p-4 text-primary align-middle font-semibold">${item.clickCount || 0}</td>
                                    <td class="p-4 text-secondary align-middle">${item.createdAt ? new Date(item.createdAt.toDate()).toLocaleDateString() : 'N/A'}</td>
                                    <td class="p-4 text-right align-middle">
                                        <button class="view-clicks-btn text-green-500 hover:text-green-700 mr-3 p-2" data-id="${item.id}"><i class="fas fa-chart-bar"></i></button>
                                        <button class="edit-shortlink-btn text-blue-500 hover:text-blue-700 mr-3 p-2" data-id="${item.id}"><i class="fas fa-pencil-alt"></i></button>
                                        <button class="delete-btn text-red-500 hover:text-red-700 p-2" data-id="${item.id}"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>`;
            container.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', handleDelete));
            container.querySelectorAll('.edit-shortlink-btn').forEach(btn => btn.addEventListener('click', handleEditShortlink));
            container.querySelectorAll('.view-clicks-btn').forEach(btn => btn.addEventListener('click', handleViewClicks));
        }


        function setupNavListeners() {
            document.getElementById('projects-link').addEventListener('click', (e) => { e.preventDefault(); switchView('projects'); });
            document.getElementById('portfolio-link').addEventListener('click', (e) => { e.preventDefault(); switchView('portfolio'); });
            document.getElementById('shortlinks-link').addEventListener('click', (e) => { e.preventDefault(); switchView('shortlinks'); });
        }
        
        // --- Modal & Form ---
        const modal = document.getElementById('form-modal');
        const modalContent = modal.querySelector('.modal-content');
        const itemForm = document.getElementById('item-form');
        const shortlinkForm = document.getElementById('shortlink-form');
        const clicksModal = document.getElementById('clicks-modal');
        
        function openModal(type) {
            if (type === 'clicks') {
                clicksModal.classList.remove('hidden'); 
                clicksModal.classList.add('flex');
                setTimeout(() => clicksModal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0'), 50);
            } else {
                modal.classList.remove('hidden'); 
                modal.classList.add('flex'); 
                setTimeout(() => modalContent.classList.remove('scale-95', 'opacity-0'), 50);
            }
        }

        function closeModal() { 
            modalContent.classList.add('scale-95', 'opacity-0');
            clicksModal.querySelector('.modal-content').classList.add('scale-95', 'opacity-0');
            setTimeout(() => { 
                modal.classList.add('hidden'); 
                clicksModal.classList.add('hidden');
                itemForm.reset(); 
                shortlinkForm.reset();
                itemForm.classList.add('hidden');
                shortlinkForm.classList.add('hidden');
            }, 300); 
        }

        function generateRandomSlug(length = 6) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        function setupModalListeners() {
            document.getElementById('add-new-btn').addEventListener('click', () => {
                if (currentCollection === 'shortlinks') {
                    shortlinkForm.reset();
                    document.getElementById('shortlink-slug').disabled = false;
                    document.getElementById('modal-title').textContent = `Add New Shortlink`;
                    shortlinkForm.classList.remove('hidden');
                    itemForm.classList.add('hidden');
                } else {
                    itemForm.reset();
                    document.getElementById('item-id').value = '';
                    quill.root.innerHTML = '';
                    document.getElementById('modal-title').textContent = `Add New ${currentCollection.slice(0,-1)}`;
                    itemForm.classList.remove('hidden');
                    shortlinkForm.classList.add('hidden');
                }
                openModal('form');
            });
            
            document.getElementById('generate-slug-btn').addEventListener('click', () => {
                document.getElementById('shortlink-slug').value = generateRandomSlug();
            });

            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            document.getElementById('cancel-btn').addEventListener('click', closeModal);
            document.getElementById('save-item-btn').addEventListener('click', handleSave);
            document.getElementById('close-clicks-modal-btn').addEventListener('click', closeModal);
        }
        
        async function handleEdit(e) {
            // This function is now only for Projects/Portfolio
            const { id } = e.currentTarget.dataset;
            const docRef = doc(db, currentCollection, id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const item = docSnap.data();
                itemForm.classList.remove('hidden');
                shortlinkForm.classList.add('hidden');

                document.getElementById('item-id').value = id;
                document.getElementById('item-title').value = item.title;
                document.getElementById('item-image').value = item.imageUrl;
                document.getElementById('item-external-url').value = item.externalUrl || '';
                quill.root.innerHTML = item.content || '';
                
                document.getElementById('modal-title').textContent = `Editing: ${item.title}`;
                openModal('form');
            }
        }

        async function handleEditShortlink(e) {
            const { id } = e.currentTarget.dataset;
            const docRef = doc(db, 'shortlinks', id);
            const docSnap = await getDoc(docRef);
             if (docSnap.exists()) {
                const item = docSnap.data();
                shortlinkForm.classList.remove('hidden');
                itemForm.classList.add('hidden');

                document.getElementById('shortlink-slug').value = id;
                document.getElementById('shortlink-slug').disabled = true; // Cannot edit the slug while editing
                document.getElementById('shortlink-url').value = item.url;
                
                document.getElementById('modal-title').textContent = `Editing: /${id}`;
                openModal('form');
            }
        }
        
        async function handleViewClicks(e) {
            const { id } = e.currentTarget.dataset;
            document.getElementById('clicks-modal-title').textContent = `Click Details for /${id}`;
            const clicksBody = document.getElementById('clicks-modal-body');
            clicksBody.innerHTML = `<div class="text-center py-12 text-secondary"><i class="fas fa-spinner fa-spin fa-2x"></i></div>`;
            openModal('clicks');

            const clicksQuery = query(collection(db, `shortlinks/${id}/clicks`));
            const querySnapshot = await getDocs(clicksQuery);
            const clicks = querySnapshot.docs.map(doc => doc.data());

            if (clicks.length === 0) {
                 clicksBody.innerHTML = `<p class="text-secondary text-center">No clicks recorded yet.</p>`;
                 return;
            }

            clicksBody.innerHTML = `
                <div class="bg-primary rounded-lg overflow-hidden border border-color">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-secondary">
                            <tr>
                                <th class="p-3 font-semibold text-primary">Timestamp (WIB)</th>
                                <th class="p-3 font-semibold text-primary">IP Address</th>
                                <th class="p-3 font-semibold text-primary">Location</th>
                                <th class="p-3 font-semibold text-primary">ISP</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${clicks.sort((a,b) => b.timestamp.toMillis() - a.timestamp.toMillis()).map(click => `
                                <tr class="border-t border-color">
                                    <td class="p-3 text-secondary align-middle">${new Date(click.timestamp.toDate()).toLocaleString('en-US', { timeZone: 'Asia/Jakarta' })}</td>
                                    <td class="p-3 text-primary align-middle font-mono">${click.ip || 'N/A'}</td>
                                    <td class="p-3 text-secondary align-middle">${click.location || 'N/A'}</td>
                                    <td class="p-3 text-secondary align-middle">${click.isp || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }


        async function handleDelete(e) {
            const { id } = e.currentTarget.dataset;
            // Note: Deleting a shortlink document does NOT automatically delete its 'clicks' subcollection in Firestore.
            // This is a Firestore behavior. For this tool, we'll leave them as they are (orphaned but harmless).
            if (confirm(`Are you sure you want to delete this item? This cannot be undone.`)) {
                await deleteDoc(doc(db, currentCollection, id));
            }
        }

        async function handleSave() {
            if (currentCollection === 'shortlinks') {
                const slug = document.getElementById('shortlink-slug').value.trim();
                const url = document.getElementById('shortlink-url').value.trim();
                if (!slug || !url) {
                    alert('Please provide both a short link and an original URL.');
                    return;
                }
                const isEditing = document.getElementById('shortlink-slug').disabled;
                const docRef = doc(db, "shortlinks", slug);

                if (!isEditing) { // Creating a new link
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                         alert('This short link slug already exists. Please choose a different one.');
                         return;
                    }
                    await setDoc(docRef, { url: url, clickCount: 0, createdAt: serverTimestamp() });
                } else { // Editing an existing link
                     await updateDoc(docRef, { url: url });
                }

            } else {
                const id = document.getElementById('item-id').value;
                const data = {
                    title: document.getElementById('item-title').value,
                    imageUrl: document.getElementById('item-image').value,
                    externalUrl: document.getElementById('item-external-url').value,
                    content: quill.root.innerHTML,
                };
                if (id) {
                    data.updatedAt = serverTimestamp();
                    await updateDoc(doc(db, currentCollection, id), data);
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, currentCollection), data);
                }
            }
            closeModal();
        }

        // --- Theme Toggle ---
        const themeToggle = document.getElementById('theme-toggle');
        const htmlElement = document.documentElement;
        const savedTheme = localStorage.getItem('theme') || 'light';
        htmlElement.classList.add(savedTheme);
        themeToggle.addEventListener('click', () => {
            htmlElement.classList.toggle('dark');
            htmlElement.classList.toggle('light');
            localStorage.setItem('theme', htmlElement.classList.contains('dark') ? 'dark' : 'light');
        });
    </script>
</body>
</html>
